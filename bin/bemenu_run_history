#!/bin/sh

## Source: https://tools.suckless.org/dmenu/scripts/dmenu_run_with_command_history/
## Changes:
## 1. Use fuzzel rather than dmenu
## 2. Use "run" prompt
## 3. Echo rather than exec the command by default (allows sway workspace tracking)
## 4. Support --exec flag to execute directly

# Parse arguments
EXEC_MODE=0
FUZZEL_ARGS=""

while [ $# -gt 0 ]; do
	case "$1" in
		--exec)
			EXEC_MODE=1
			shift
			;;
		*)
			FUZZEL_ARGS="$FUZZEL_ARGS $1"
			shift
			;;
	esac
done

cachedir=${XDG_CACHE_HOME:-"$HOME/.cache"}
if [ -d "$cachedir" ]; then
	cache=$cachedir/dmenu_run
	historyfile=$cachedir/dmenu_history
else
	cache=$HOME/.dmenu_cache
	historyfile=$HOME/.dmenu_history
fi

IFS=:
if stest -dqr -n "$cache" $PATH; then
	stest -flx $PATH | sort -u > "$cache"
fi
unset IFS

awk -v histfile=$historyfile '
	BEGIN {
		while( (getline < histfile) > 0 ) {
			sub("^[0-9]+\t","")
			print
			x[$0]=1
		}
	} !x[$0]++ ' "$cache" \
	| fuzzel -w 120 --dmenu -p "> " $FUZZEL_ARGS \
	| awk -v histfile=$historyfile '
		BEGIN {
			FS=OFS="\t"
			while ( (getline < histfile) > 0 ) {
				count=$1
				sub("^[0-9]+\t","")
				fname=$0
				history[fname]=count
			}
			close(histfile)
		}
		{
			history[$0]++
			print
		}
		END {
			if(!NR) exit
			for (f in history)
				print history[f],f | "sort -t '\t' -k1rn >" histfile
		}
	' \
	| while read cmd; do
		if [ $EXEC_MODE -eq 1 ]; then
			${SHELL:-"/bin/sh"} -c "$cmd" &
		else
			echo "$cmd"
		fi
	done
